{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rechercher un trajet</title>

    <link rel="stylesheet" href="{% static 'APP/rechercher.css' %}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Montserrat&family=Open+Sans&family=Poppins&display=swap"
        rel="stylesheet"
    />
</head>

<body>
<div class="app">
    <header class="header">
        <div class="container">
            <h1 class="title">Rechercher un Trajet</h1>
            <p class="subtitle">Trouvez le trajet parfait pour votre destination</p>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <section class="search-section">
                <form method="get" action="{% url 'rechercher' %}" class="search-form">
                    <div class="form-group">
                        <label for="departure">Point de d√©part</label>
                        <input type="text" id="departure" name="departure" placeholder="Ex: IFRI-UAC" value="{{ filtres.point_depart }}">
                    </div>
                    <div class="form-group">
                        <label for="destination">Destination</label>
                        <input type="text" id="destination" name="destination" placeholder="Ex: Arconville" value="{{ filtres.point_arrivee }}">
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" name="date" value="{{ filtres.date }}">
                    </div>
                    <button type="submit" class="search-btn">Rechercher</button>
                </form>
            </section>

            <div class="content-grid">
                <section class="results-section">
                    <div id="initial-state" class="search-state {% if offres or demande_creee %}hidden{% endif %}">
                        <div class="search-icon">üîç</div>
                        <p>Lancez une recherche pour voir les trajets disponibles</p>
                    </div>

                    <div id="no-results" class="search-state {% if offres or demande_creee %}hidden{% else %}{% if filtres.point_depart or filtres.point_arrivee or filtres.date %}{% else %}hidden{% endif %}{% endif %}">
                        <div class="search-icon">üîç</div>
                        <h3>Aucun trajet trouv√©</h3>
                        <p>Essayez de modifier vos crit√®res de recherche</p>
                        <a href="{% url 'rechercher' %}" class="clear-btn">Effacer les filtres</a>
                    </div>

                    {% if demande_creee and matches %}
                    <div class="match-section">
                        <h2>üîó {{ matches|length }} offre(s) compatible(s) trouv√©e(s)</h2>
                        {% for match in matches %}
                        <div class="offre-item">
                            <span class="badge-match">MATCH</span>
                            <h3>{{ match.offre.point_depart }} ‚Üí {{ match.offre.point_arrivee }}</h3>
                            <p><strong>D√©part :</strong> {{ match.offre.heure_depart|date:"d/m/Y H:i" }}</p>
                            <p><strong>Conducteur :</strong> {{ match.offre.conducteur.get_full_name }}</p>
                            <p><strong>Places :</strong> {{ match.offre.places_disponibles }}</p>
                            <p><strong>Prix :</strong> {{ match.offre.prix }} FCFA</p>
                            {% if match.offre.description %}
                            <p><strong>Description :</strong> {{ match.offre.description }}</p>
                            {% endif %}
                            <p><strong>Score de compatibilit√© :</strong> {{ match.score|floatformat:1 }}%</p>

                            <button class="btn btn-primary" onclick="createMatching('{{ match.offre.id }}', '{{ demande_creee.id }}')">
                                R√©server ce trajet
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if offres %}
                    <div class="offres-section">
                        <h2>üöó Offres disponibles</h2>
                        {% for offre in offres %}
                        <div class="offre-item">
                            <h3>{{ offre.point_depart }} ‚Üí {{ offre.point_arrivee }}</h3>
                            <p>D√©part : {{ offre.heure_depart }}</p>
                            <p>Places disponibles : {{ offre.places_disponibles }}</p>
                            <p>Prix : {{ offre.prix }} FCFA</p>
                            <p>Description : {{ offre.description }}</p>
                            <p>Conducteur : {{ offre.conducteur.get_full_name }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </section>

                <aside class="sidebar">
                    <section class="demande-section">
                        <h2>Cr√©er une demande de covoiturage</h2>
                        {% if error %}
                        <p style="color:red;">{{ error }}</p>
                        {% endif %}
                        <form method="post" action="{% url 'rechercher' %}">
                            {% csrf_token %}
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                            <div class="form-group">
                                <label for="point_depart_demande">Point de d√©part :</label>
                                <input type="text" id="point_depart_demande" name="point_depart_demande" required>
                            </div>
                            <div class="form-group">
                                <label for="point_arrivee_demande">Destination :</label>
                                <input type="text" id="point_arrivee_demande" name="point_arrivee_demande" required>
                            </div>
                            <div class="form-group">
                                <label for="heure_souhaitee">Heure souhait√©e :</label>
                                <input type="datetime-local" id="heure_souhaitee" name="heure_souhaitee" required>
                            </div>
                            <button type="submit">Cr√©er la demande</button>
                        </form>
                    </section>

                    <div class="map-section">
                        <h3>Carte</h3>
                        <div class="map-placeholder">
                            <div class="map-content">
                                <div class="map-icon">üó∫Ô∏è</div>
                                <p>Carte interactive</p>
                                <small>Visualisation des trajets</small>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>
</div>

<script>
    function createMatching(offreId, demandeId) {
        if (!confirm('Confirmer la r√©servation de ce trajet ?')) return;
        fetch("{% url 'create_matching' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ offre_id: offreId, demande_id: demandeId })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("R√©servation r√©ussie !");
                location.reload();
            } else {
                alert("Erreur : " + data.error);
            }
        })
        .catch(err => {
            alert("Erreur de communication");
            console.error(err);
        });
    }

    window.onload = function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (position) {
                    document.getElementById('latitude').value = position.coords.latitude;
                    document.getElementById('longitude').value = position.coords.longitude;
                },
                function () {
                    console.warn("G√©olocalisation refus√©e");
                }
            );
        }
    };
</script>

<style>
    .badge-match {
        display: inline-block;
        background-color: #2ecc71;
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .btn-primary {
        margin-top: 0.5rem;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
    }
</style>
</body>
</html>
